<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script>
      window.onload = function () {
        var dropZone = document.getElementById('drop_zone');
        dropZone.addEventListener('dragover', handleDragOver, false);
        dropZone.addEventListener('drop', handleFileSelect, false);
      };

      var host = location.origin.replace(/^http/, 'ws');
      var context = window.location.pathname.substring(0, window.location.pathname.indexOf('/', 2));
      var url = host + context + '/Chat';
//      var url = ws://example.com/hoge;
      var ws = new WebSocket(url);
      var iam = 'Taro';

      ws.onopen = function () {
        ws.send(iam + ' が接続しました');
      };

      ws.onmessage = function (message) {
        var tag = null;
        if (typeof message.data === "string") {
          tag = document.createElement('div');
          tag.appendChild(document.createTextNode(message.data));
        } else {
          tag = new Image();
          tag.src = URL.createObjectURL(message.data);
        }
        if (tag) {
          document.getElementById('logs').appendChild(tag);
        }
      };

      function postToServer() {
        ws.send(iam + '：' + document.getElementById('msg').value);
        document.getElementById('msg').value = '';
      }

      function closeConnect() {
        ws.send(iam + ' が切断しました');
        ws.close();
      }

      function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.dataTransfer.files; // FileList object.

        // files is a FileList of File objects. List some properties.
        var output = [];
        for (var i = 0, f; f = files[i]; i++) {
//          output.push('<strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
//                  f.size, ' bytes, last modified: ',
//                  f.lastModifiedDate.toLocaleDateString());
          if (f.type.match(/(jpe*g|png)$/i)) {
            ws.send(f);
          } else {
            alert('画像ファイル（jpg, png）のみ送信できます');
          }
        }
        var tag = document.createElement('div');
        tag.innerHTML = output.join('');
        document.getElementById('logs').appendChild(tag);
      }

      function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
      }
    </script>
  </head>
  <body>
    <div>
      <div><input id="msg" type="text" placeholder="メッセージ" style = "width: 600px;"/></div>
      <div id="drop_zone" style="
           width: 600px;
           height: 100px;
           border: lightgray thin dashed;
           display: table-cell;
           text-align: center;
           vertical-align: middle;">
        スタンプ</div>
      <div>
        <button type="button" onClick="postToServer()">話す</button>
        <button type="button" onClick="closeConnect()">終了</button>
      </div>
    </div>
    <div id="logs"></div>
  </body>
</html>